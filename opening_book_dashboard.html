<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HEXUKI Opening Book Analysis</title>
    <style>
        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
        }

        h1 {
            text-align: center;
            color: #0f3460;
            background: linear-gradient(90deg, #00d4ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: #aaa;
            margin-bottom: 30px;
        }

        .control-panel {
            background: #16213e;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        button {
            background: linear-gradient(135deg, #00d4ff, #00ff88);
            color: #000;
            border: none;
            padding: 12px 28px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 212, 255, 0.4);
        }

        button:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
            transform: none;
        }

        .progress-container {
            background: #0f1419;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .progress-container.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #222;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #00ff88);
            width: 0%;
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: bold;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-box {
            background: #0f1419;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-label {
            color: #888;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            background: linear-gradient(90deg, #00d4ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .results-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 900px) {
            .results-container {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: #16213e;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .panel h2 {
            margin-top: 0;
            color: #00d4ff;
            border-bottom: 2px solid #00d4ff;
            padding-bottom: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #333;
        }

        th {
            background: #0f1419;
            color: #00d4ff;
            font-weight: bold;
        }

        tr:hover {
            background: #1a2332;
        }

        .rank-1 { background: rgba(255, 215, 0, 0.1); }
        .rank-2 { background: rgba(192, 192, 192, 0.1); }
        .rank-3 { background: rgba(205, 127, 50, 0.1); }

        .hex-grid {
            display: grid;
            grid-template-columns: repeat(5, 60px);
            gap: 5px;
            margin: 20px auto;
            width: fit-content;
        }

        .hex-cell {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-weight: bold;
            font-size: 12px;
            text-align: center;
            border: 2px solid #333;
            transition: all 0.3s;
        }

        .hex-cell:hover {
            transform: scale(1.1);
            z-index: 10;
        }

        .hex-empty {
            background: #1a1a2e;
            color: #555;
        }

        .winrate-high { background: rgba(0, 255, 136, 0.3); border-color: #00ff88; }
        .winrate-med { background: rgba(0, 212, 255, 0.2); border-color: #00d4ff; }
        .winrate-low { background: rgba(255, 100, 100, 0.2); border-color: #ff6464; }

        .loading {
            text-align: center;
            color: #aaa;
            padding: 40px;
            font-style: italic;
        }

        .export-btn {
            background: linear-gradient(135deg, #00ff88, #00d4ff);
            margin-left: auto;
        }
    </style>
</head>
<body>
    <h1>üìä HEXUKI Opening Book Analyzer</h1>
    <p class="subtitle">Discover the strongest opening moves through AI self-play analysis</p>

    <div class="control-panel">
        <h2 style="margin-top:0; color: #00d4ff;">Analysis Controls</h2>

        <div class="controls">
            <button id="startBtn" onclick="startAnalysis()">üöÄ Start Analysis (1000 games)</button>
            <button id="pauseBtn" onclick="pauseAnalysis()" disabled>‚è∏ Pause</button>
            <button id="stopBtn" onclick="stopAnalysis()" disabled>‚èπ Stop</button>
            <button class="export-btn" id="exportBtn" onclick="exportResults()" disabled>üíæ Export JSON</button>
        </div>

        <div id="progressContainer" class="progress-container">
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill">0%</div>
            </div>

            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-label">Games Completed</div>
                    <div class="stat-value" id="gamesCompleted">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Current Batch</div>
                    <div class="stat-value" id="currentBatch">0/10</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Openings Found</div>
                    <div class="stat-value" id="openingsFound">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Estimated Time</div>
                    <div class="stat-value" id="estimatedTime">~30min</div>
                </div>
            </div>

            <div style="margin-top: 15px; padding: 15px; background: #0a0a0a; border-radius: 8px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;" id="liveLog">
                <div style="color: #888;">Activity log will appear here...</div>
            </div>
        </div>
    </div>

    <div class="results-container">
        <div class="panel">
            <h2>üèÜ Top Opening Moves</h2>
            <div id="topOpenings">
                <div class="loading">Run analysis to see results...</div>
            </div>
        </div>

        <div class="panel">
            <h2>üó∫Ô∏è Hex Position Heatmap</h2>
            <div id="hexHeatmap">
                <div class="loading">Run analysis to see heatmap...</div>
            </div>
        </div>

        <div class="panel">
            <h2>üé≤ Tile Value Analysis</h2>
            <div id="tileAnalysis">
                <div class="loading">Run analysis to see tile stats...</div>
            </div>
        </div>

        <div class="panel">
            <h2>üìà All Openings</h2>
            <div id="allOpenings">
                <div class="loading">Run analysis to see complete data...</div>
            </div>
        </div>
    </div>

    <script src="hexuki_game_engine_v2.js"></script>
    <script src="mcts_ai_player.js"></script>
    <script src="opening_book_generator.js"></script>

    <script>
        let generator = null;
        let startTime = null;

        async function startAnalysis() {
            // Disable start button
            document.getElementById('startBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('stopBtn').disabled = false;

            // Show progress
            document.getElementById('progressContainer').classList.add('active');

            // Clear log
            document.getElementById('liveLog').innerHTML = '';

            // Create generator with lower sim counts for browser compatibility
            // 1000 sims for first move, then 300 for rest = faster without browser warnings
            generator = new OpeningBookGenerator(1000, 20);
            startTime = Date.now();

            log('Starting opening book generation...', '#0f0');
            log('Config: 1000 MCTS sims for first move, 300 for rest', '#888');
            log('Target: 1000 games in batches of 100', '#888');

            // Set up callbacks
            generator.callbacks.onProgress = (progress) => {
                updateProgress(progress);
            };

            generator.callbacks.onGameComplete = (gameInfo) => {
                // Log every 10th game
                if (gameInfo.gameNum % 10 === 0) {
                    log(`Game ${gameInfo.gameNum}: Opening ${gameInfo.opening}, Winner: P${gameInfo.winner}`, '#0f0');
                }
            };

            generator.callbacks.onBatchComplete = (analysis) => {
                log(`Batch complete! ${analysis.uniqueOpenings} unique openings found`, '#ff0');
                updateResults(analysis);
            };

            generator.callbacks.onAnalysisComplete = (analysis) => {
                onAnalysisComplete(analysis);
            };

            log('Starting first batch...', '#0dd');

            // Start generation
            await generator.generateOpeningBook(1000, 100);
        }

        function pauseAnalysis() {
            if (generator.isPaused) {
                generator.resume();
                document.getElementById('pauseBtn').textContent = '‚è∏ Pause';
            } else {
                generator.pause();
                document.getElementById('pauseBtn').textContent = '‚ñ∂ Resume';
            }
        }

        function stopAnalysis() {
            if (generator) {
                generator.stop();
            }
            resetControls();
        }

        function log(message, color = '#0f0') {
            const logDiv = document.getElementById('liveLog');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.style.color = color;
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;

            // Keep only last 50 entries
            while (logDiv.children.length > 50) {
                logDiv.removeChild(logDiv.firstChild);
            }
        }

        function updateProgress(progress) {
            const percent = (progress.totalGames / 1000 * 100).toFixed(0);
            const fill = document.getElementById('progressFill');
            fill.style.width = percent + '%';
            fill.textContent = percent + '%';

            document.getElementById('gamesCompleted').textContent = progress.totalGames;
            document.getElementById('currentBatch').textContent = `${progress.batch}/10`;

            // Estimate time remaining
            const elapsed = Date.now() - startTime;
            const rate = progress.totalGames / (elapsed / 1000);
            const remaining = (1000 - progress.totalGames) / rate;
            const mins = Math.ceil(remaining / 60);
            document.getElementById('estimatedTime').textContent = mins > 0 ? `~${mins}min` : '<1min';

            log(`Batch ${progress.batch}/10 - ${progress.totalGames}/1000 games (${(rate*60).toFixed(1)} games/min)`, '#0dd');
        }

        function updateResults(analysis) {
            document.getElementById('openingsFound').textContent = analysis.uniqueOpenings;

            // Update top openings
            updateTopOpenings(analysis);

            // Update heatmap
            updateHexHeatmap(analysis);

            // Update tile analysis
            updateTileAnalysis(analysis);

            // Update full table
            updateAllOpenings(analysis);
        }

        function updateTopOpenings(analysis) {
            const top = analysis.openings.slice(0, 10);
            const html = `
                <table>
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Hex</th>
                            <th>Tile</th>
                            <th>Win%</th>
                            <th>Avg Score</th>
                            <th>Games</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${top.map((o, i) => `
                            <tr class="${i < 3 ? 'rank-' + (i + 1) : ''}">
                                <td>${i + 1}</td>
                                <td>${o.hexId}</td>
                                <td>${o.tileValue}</td>
                                <td>${(o.winRate * 100).toFixed(1)}%</td>
                                <td>${o.avgScoreDiff > 0 ? '+' : ''}${o.avgScoreDiff.toFixed(0)}</td>
                                <td>${o.games}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('topOpenings').innerHTML = html;
        }

        function updateHexHeatmap(analysis) {
            const hexAnalysis = generator.getHexAnalysis();
            const hexMap = new Map(hexAnalysis.map(h => [h.hexId, h]));

            // Simple grid layout (adjust as needed for your hex positions)
            const layout = [
                [null, null, 0, null, null],
                [null, 1, null, 2, null],
                [3, null, 4, null, 5],
                [null, 6, null, 7, null],
                [8, null, 9, null, 10],
                [null, 11, null, 12, null],
                [13, null, 14, null, 15],
                [null, 16, null, 17, null],
                [null, null, 18, null, null]
            ];

            let html = '<div class="hex-grid" style="grid-template-columns: repeat(5, 60px);">';

            layout.forEach(row => {
                row.forEach(hexId => {
                    if (hexId === null) {
                        html += '<div class="hex-cell hex-empty"></div>';
                    } else {
                        const hex = hexMap.get(hexId);
                        const winRate = hex ? hex.avgWinRate : 0;
                        const games = hex ? hex.games : 0;

                        let className = 'hex-cell ';
                        if (games === 0) className += 'hex-empty';
                        else if (winRate > 0.52) className += 'winrate-high';
                        else if (winRate > 0.48) className += 'winrate-med';
                        else className += 'winrate-low';

                        const display = games > 0 ? `${hexId}<br>${(winRate * 100).toFixed(0)}%` : hexId;
                        html += `<div class="${className}" title="Hex ${hexId}: ${(winRate*100).toFixed(1)}% (${games} games)">${display}</div>`;
                    }
                });
            });

            html += '</div>';
            html += '<p style="text-align:center; color:#888; font-size:12px;">Green = High win rate | Blue = Medium | Red = Low</p>';

            document.getElementById('hexHeatmap').innerHTML = html;
        }

        function updateTileAnalysis(analysis) {
            const tiles = generator.getTileAnalysis();
            const html = `
                <table>
                    <thead>
                        <tr>
                            <th>Tile Value</th>
                            <th>Games</th>
                            <th>Win Rate</th>
                            <th>Avg Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tiles.map(t => `
                            <tr>
                                <td>${t.tileValue}</td>
                                <td>${t.games}</td>
                                <td>${(t.avgWinRate * 100).toFixed(1)}%</td>
                                <td>${t.avgScoreDiff > 0 ? '+' : ''}${t.avgScoreDiff.toFixed(0)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('tileAnalysis').innerHTML = html;
        }

        function updateAllOpenings(analysis) {
            const html = `
                <div style="max-height: 400px; overflow-y: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Hex</th>
                                <th>Tile</th>
                                <th>Win%</th>
                                <th>Games</th>
                                <th>Confidence</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${analysis.openings.map(o => `
                                <tr>
                                    <td>${o.hexId}</td>
                                    <td>${o.tileValue}</td>
                                    <td>${(o.winRate * 100).toFixed(1)}%</td>
                                    <td>${o.games}</td>
                                    <td>${o.significance}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            document.getElementById('allOpenings').innerHTML = html;
        }

        function onAnalysisComplete(analysis) {
            resetControls();
            document.getElementById('exportBtn').disabled = false;

            const elapsed = (Date.now() - startTime) / 1000;
            const mins = Math.floor(elapsed / 60);
            const secs = Math.floor(elapsed % 60);

            alert(`Analysis complete!\n${analysis.totalGames} games in ${mins}m ${secs}s\nTop opening: Hex ${analysis.topOpening.hexId}, Tile ${analysis.topOpening.tileValue} (${(analysis.topOpening.winRate*100).toFixed(1)}% win rate)`);
        }

        function resetControls() {
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('pauseBtn').textContent = '‚è∏ Pause';
        }

        function exportResults() {
            if (!generator) return;

            const data = generator.exportOpeningBook();
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `hexuki_opening_book_${Date.now()}.json`;
            a.click();

            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
