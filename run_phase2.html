<!DOCTYPE html>
<html>
<head>
    <title>Phase 2 Runner - Policy-Guided Training</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
        }
        h1 { color: #00ff00; }
        h2 { color: #00cc00; font-size: 18px; margin-top: 30px; }
        .controls {
            background: #2a2a2a;
            border: 2px solid #00ff00;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .control-group {
            margin: 15px 0;
        }
        label {
            display: inline-block;
            width: 200px;
            color: #00cc00;
        }
        input, select {
            background: #000;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 5px 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        #output {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            height: 500px;
            overflow-y: auto;
            font-size: 12px;
            white-space: pre-wrap;
            margin-top: 20px;
        }
        button {
            background: #00ff00;
            color: #1a1a1a;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover { background: #00cc00; }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .error { color: #ff0000; }
        .success { color: #00ff00; }
        .warn { color: #ff9900; }
        .info { color: #00ccff; }
        .section {
            background: #2a2a2a;
            border: 1px solid #00ff00;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        .metric-box {
            background: #000;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #00ff00;
        }
        .metric-label {
            color: #00cc00;
            font-size: 11px;
        }
        .metric-value {
            color: #00ff00;
            font-size: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Phase 2 - Policy-Guided Training</h1>

    <div class="controls">
        <h2>Training Configuration</h2>

        <div class="control-group">
            <label>Training Mode:</label>
            <select id="trainingMode">
                <option value="quick">Quick Test (100 games)</option>
                <option value="standard">Standard (500 games, 3 gens)</option>
                <option value="extended">Extended (1000 games, 5 gens)</option>
                <option value="opening-book" selected>Opening Book (15K games, optimized) ⭐</option>
                <option value="custom">Custom</option>
            </select>
        </div>

        <div id="customControls" style="display: none;">
            <div class="control-group">
                <label>Games per Generation:</label>
                <input type="number" id="gamesPerGen" value="1000" min="10" max="10000">
            </div>
            <div class="control-group">
                <label>Number of Generations:</label>
                <input type="number" id="numGenerations" value="5" min="1" max="20">
            </div>
            <div class="control-group">
                <label>Initial Exploration Rate:</label>
                <input type="number" id="explorationRate" value="0.3" min="0.01" max="1.0" step="0.01">
            </div>
        </div>

        <div class="control-group">
            <label>Adaptive Exploration:</label>
            <input type="checkbox" id="adaptiveExploration" checked>
            <span style="color: #00cc00; margin-left: 10px;">Auto-adjust exploration based on learning metrics</span>
        </div>

        <h2>Opening Book Training (Focus on First Moves!)</h2>

        <div class="control-group">
            <label>Opening Book Mode:</label>
            <input type="checkbox" id="openingBookMode">
            <span style="color: #00cc00; margin-left: 10px;">Train only on opening moves (faster, focused learning)</span>
        </div>

        <div id="openingBookControls" style="display: none;">
            <div class="control-group">
                <label>Max Moves to Learn:</label>
                <input type="number" id="maxMoveToLearn" value="8" min="2" max="18" step="2">
                <span style="color: #ffff00; margin-left: 10px; font-size: 12px;">Games play to completion, but only learn first N moves</span>
            </div>
        </div>

        <h2>Opponent Diversity (Break Through Plateaus!)</h2>

        <div class="control-group">
            <label>Opponent Mix:</label>
            <select id="opponentMix">
                <option value="self">Self-Play Only (default)</option>
                <option value="mixed-light">Light Mix (80% self, 20% random)</option>
                <option value="mixed-medium" selected>Medium Mix (60% self, 40% random) ⭐ Recommended</option>
                <option value="mixed-heavy">Heavy Mix (40% self, 60% random)</option>
                <option value="vs-opponent">Vs Opponent Policy</option>
                <option value="custom-mix">Custom Mix</option>
            </select>
        </div>

        <div id="customMixControls" style="display: none;">
            <div class="control-group">
                <label>Self-Play %:</label>
                <input type="number" id="selfRatio" value="40" min="0" max="100" step="10">
            </div>
            <div class="control-group">
                <label>Vs Random %:</label>
                <input type="number" id="randomRatio" value="60" min="0" max="100" step="10">
            </div>
            <div class="control-group">
                <label>Vs Opponent %:</label>
                <input type="number" id="opponentRatio" value="0" min="0" max="100" step="10">
            </div>
        </div>

        <div class="control-group">
            <label>Import Existing Policy:</label>
            <input type="file" id="policyFile" accept=".json">
        </div>

        <div class="control-group">
            <label>Import Opponent Policy:</label>
            <input type="file" id="opponentFile" accept=".json">
            <span style="color: #ffff00; margin-left: 10px; font-size: 12px;">Optional: Train against older/different policy</span>
        </div>

        <div style="margin-top: 20px;">
            <button id="startBtn" onclick="startTraining()">Start Training</button>
            <button id="stopBtn" onclick="stopTraining()" disabled>Stop Training</button>
            <button onclick="clearOutput()">Clear Output</button>
            <button onclick="exportPolicy()">Export Policy</button>
            <button onclick="exportLogs()">Export Logs</button>
        </div>
    </div>

    <div class="section" id="metricsSection" style="display: none;">
        <h2>Current Generation Metrics</h2>
        <div class="metrics">
            <div class="metric-box">
                <div class="metric-label">Generation</div>
                <div class="metric-value" id="metricGeneration">-</div>
            </div>
            <div class="metric-box">
                <div class="metric-label">Games Completed</div>
                <div class="metric-value" id="metricGames">-</div>
            </div>
            <div class="metric-box">
                <div class="metric-label">Games/Second</div>
                <div class="metric-value" id="metricSpeed">-</div>
            </div>
            <div class="metric-box">
                <div class="metric-label">Positions Explored</div>
                <div class="metric-value" id="metricPositions">-</div>
            </div>
            <div class="metric-box">
                <div class="metric-label">Policy Stability</div>
                <div class="metric-value" id="metricStability">-</div>
            </div>
            <div class="metric-box">
                <div class="metric-label">Coverage Growth</div>
                <div class="metric-value" id="metricGrowth">-</div>
            </div>
        </div>
    </div>

    <div id="output"></div>

    <script src="hexuki_game_engine_v2.js"></script>
    <script src="hexuki_ai_trainer.js"></script>
    <script>
        const output = document.getElementById('output');
        let runner = null;
        let isTraining = false;

        // Override console.log to display in output
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            const message = args.map(arg =>
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');

            let className = '';
            if (message.includes('❌') || message.includes('ERROR')) className = 'error';
            else if (message.includes('✅') || message.includes('passed') || message.includes('COMPLETE')) className = 'success';
            else if (message.includes('⚠️') || message.includes('WARN')) className = 'warn';
            else if (message.includes('ℹ️') || message.includes('INFO')) className = 'info';

            const line = document.createElement('div');
            line.className = className;
            line.textContent = message;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        };

        // Show/hide custom controls and auto-configure opening book mode
        document.getElementById('trainingMode').addEventListener('change', function() {
            const isCustom = this.value === 'custom';
            const isOpeningBook = this.value === 'opening-book';

            document.getElementById('customControls').style.display = isCustom ? 'block' : 'none';

            // Auto-enable opening book mode when selected
            if (isOpeningBook) {
                document.getElementById('openingBookMode').checked = true;
                document.getElementById('maxMoveToLearn').value = 6;
                document.getElementById('openingBookControls').style.display = 'block';
            }
        });

        // Show/hide custom mix controls
        document.getElementById('opponentMix').addEventListener('change', function() {
            const isCustomMix = this.value === 'custom-mix';
            document.getElementById('customMixControls').style.display = isCustomMix ? 'block' : 'none';
        });

        // Show/hide opening book controls
        document.getElementById('openingBookMode').addEventListener('change', function() {
            const isOpeningBook = this.checked;
            document.getElementById('openingBookControls').style.display = isOpeningBook ? 'block' : 'none';
        });

        function clearOutput() {
            output.innerHTML = '';
        }

        function getOpponentMix() {
            const mixType = document.getElementById('opponentMix').value;

            if (mixType === 'self') {
                return {'self-play': 1.0};
            } else if (mixType === 'mixed-light') {
                return {'self': 0.8, 'random': 0.2};
            } else if (mixType === 'mixed-medium') {
                return {'self': 0.6, 'random': 0.4};
            } else if (mixType === 'mixed-heavy') {
                return {'self': 0.4, 'random': 0.6};
            } else if (mixType === 'vs-opponent') {
                return {'opponent': 1.0};
            } else if (mixType === 'custom-mix') {
                const self = parseFloat(document.getElementById('selfRatio').value) / 100;
                const random = parseFloat(document.getElementById('randomRatio').value) / 100;
                const opponent = parseFloat(document.getElementById('opponentRatio').value) / 100;
                return {'self': self, 'random': random, 'opponent': opponent};
            }
            return {'self-play': 1.0}; // fallback
        }

        function getTrainingConfig() {
            const mode = document.getElementById('trainingMode').value;
            const adaptive = document.getElementById('adaptiveExploration').checked;
            const opponentMix = getOpponentMix();

            let config = [];
            if (mode === 'quick') {
                config = [
                    {games: 100, exploration: 0.3, adaptive: adaptive, mode: opponentMix}
                ];
            } else if (mode === 'standard') {
                config = [
                    {games: 500, exploration: 0.3, adaptive: adaptive, mode: opponentMix},
                    {games: 500, exploration: 0.2, adaptive: adaptive, mode: opponentMix},
                    {games: 500, exploration: 0.1, adaptive: adaptive, mode: opponentMix}
                ];
            } else if (mode === 'extended') {
                config = [
                    {games: 1000, exploration: 0.3, adaptive: adaptive, mode: opponentMix},
                    {games: 1000, exploration: 0.2, adaptive: adaptive, mode: opponentMix},
                    {games: 1000, exploration: 0.15, adaptive: adaptive, mode: opponentMix},
                    {games: 1000, exploration: 0.1, adaptive: adaptive, mode: opponentMix},
                    {games: 1000, exploration: 0.05, adaptive: adaptive, mode: opponentMix}
                ];
            } else if (mode === 'opening-book') {
                // OPTIMIZED OPENING BOOK TRAINING - TWO-PHASE APPROACH
                // Phase 1 (Gen 1-3): Rapid exploration decay to discover good openings
                // Phase 2 (Gen 4-15): Ultra-low exploration to deeply master those openings
                const mixMode = {"self": 0.6, "random": 0.4}; // Fixed optimal mix
                config = [
                    // Phase 1: Discovery
                    {games: 1000, exploration: 0.02, adaptive: false, mode: mixMode},
                    {games: 1000, exploration: 0.004, adaptive: false, mode: mixMode},
                    {games: 1000, exploration: 0.001, adaptive: false, mode: mixMode},
                    // Phase 2: Deep Learning (pure exploitation)
                    {games: 1000, exploration: 0.0001, adaptive: false, mode: mixMode},
                    {games: 1000, exploration: 0.0001, adaptive: false, mode: mixMode},
                    {games: 1000, exploration: 0.0001, adaptive: false, mode: mixMode},
                    {games: 1000, exploration: 0.0001, adaptive: false, mode: mixMode},
                    {games: 1000, exploration: 0.0001, adaptive: false, mode: mixMode},
                    {games: 1000, exploration: 0.0001, adaptive: false, mode: mixMode},
                    {games: 1000, exploration: 0.0001, adaptive: false, mode: mixMode},
                    {games: 1000, exploration: 0.0001, adaptive: false, mode: mixMode},
                    {games: 1000, exploration: 0.0001, adaptive: false, mode: mixMode},
                    {games: 1000, exploration: 0.0001, adaptive: false, mode: mixMode},
                    {games: 1000, exploration: 0.0001, adaptive: false, mode: mixMode},
                    {games: 1000, exploration: 0.0001, adaptive: false, mode: mixMode}
                ];
            } else { // custom
                const gamesPerGen = parseInt(document.getElementById('gamesPerGen').value);
                const numGens = parseInt(document.getElementById('numGenerations').value);
                const baseExploration = parseFloat(document.getElementById('explorationRate').value);

                for (let i = 0; i < numGens; i++) {
                    const exploration = baseExploration * Math.pow(0.7, i);
                    config.push({games: gamesPerGen, exploration: exploration, adaptive: adaptive, mode: opponentMix});
                }
            }

            return config;
        }

        async function startTraining() {
            clearOutput();
            console.log('═══════════════════════════════════════');
            console.log('🚀 STARTING PHASE 2 TRAINING');
            console.log('═══════════════════════════════════════\n');

            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('metricsSection').style.display = 'block';
            isTraining = true;

            try {
                // Check if importing existing policy
                const policyFile = document.getElementById('policyFile').files[0];
                let initialPolicy = null;

                if (policyFile) {
                    console.log(`📂 Loading policy from ${policyFile.name}...`);
                    const text = await policyFile.text();
                    const json = JSON.parse(text);
                    initialPolicy = HexukiAI.PolicyDatabase.fromJSON(json);
                    console.log(`✅ Loaded policy with ${initialPolicy.getSummary().positionsExplored} positions\n`);
                }

                // Check if importing opponent policy
                const opponentFile = document.getElementById('opponentFile').files[0];
                let opponentPolicy = null;

                if (opponentFile) {
                    console.log(`📂 Loading opponent policy from ${opponentFile.name}...`);
                    const text = await opponentFile.text();
                    const json = JSON.parse(text);
                    opponentPolicy = HexukiAI.PolicyDatabase.fromJSON(json);
                    console.log(`✅ Loaded opponent with ${opponentPolicy.getSummary().positionsExplored} positions\n`);
                }

                // Get opening book options
                const openingBookMode = document.getElementById('openingBookMode').checked;
                const maxMoveToLearn = parseInt(document.getElementById('maxMoveToLearn').value);

                const runnerOptions = {
                    openingBookMode: openingBookMode,
                    maxMoveToLearn: openingBookMode ? maxMoveToLearn : 18
                };

                // Create runner with opponent and options
                runner = new HexukiAI.Phase2Runner(initialPolicy, opponentPolicy, runnerOptions);

                if (openingBookMode) {
                    console.log(`🎯 Opening Book Mode: Learning first ${maxMoveToLearn} moves only (AlphaGo approach)\n`);
                    console.log(`   Games play to completion for reliable winners, policy stays small\n`);
                }

                // Get configuration
                const config = getTrainingConfig();
                console.log(`Configuration: ${config.length} generations planned\n`);

                // Run training with progress updates
                const startTime = Date.now();

                for (let i = 0; i < config.length; i++) {
                    if (!isTraining) {
                        console.log('⏸️ Training stopped by user\n');
                        break;
                    }

                    const gen = config[i];
                    console.log(`\n═══ GENERATION ${i + 1}/${config.length} ═══`);

                    const genStats = await runner.runGeneration(gen.games, gen.exploration, gen.mode);

                    // Update metrics display
                    updateMetrics(genStats);

                    // Yield to browser
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                const totalTime = (Date.now() - startTime) / 1000;

                // Final summary
                console.log('\n═══════════════════════════════════════');
                console.log('📊 TRAINING COMPLETE');
                console.log('═══════════════════════════════════════');
                console.log(`Total Time: ${totalTime.toFixed(2)}s`);
                console.log(`Final Policy Summary:`);
                const summary = runner.policy.getSummary();
                console.log(`  Positions: ${summary.positionsExplored}`);
                console.log(`  Unique Moves: ${summary.uniqueMovesExplored}`);
                console.log(`  Total Games: ${summary.totalGamesPlayed}`);

                if (runner.generationHistory.length > 1) {
                    const firstGen = runner.generationHistory[0];
                    const lastGen = runner.generationHistory[runner.generationHistory.length - 1];
                    console.log('\nLearning Progress:');
                    console.log(`  Position Growth: ${firstGen.positionsExplored} → ${lastGen.positionsExplored}`);
                    console.log(`  Stability: ${(firstGen.learningMetrics.stability * 100).toFixed(1)}% → ${(lastGen.learningMetrics.stability * 100).toFixed(1)}%`);
                    console.log(`  Confidence: ${(firstGen.learningMetrics.confidenceRatio * 100).toFixed(1)}% → ${(lastGen.learningMetrics.confidenceRatio * 100).toFixed(1)}%`);
                }

                console.log('\n✅ Training complete! Export policy to save your progress.');

            } catch (error) {
                console.log('❌ ERROR:', error.message);
                console.log(error.stack);
            }

            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            isTraining = false;
        }

        function stopTraining() {
            isTraining = false;
            document.getElementById('stopBtn').disabled = true;
        }

        function updateMetrics(stats) {
            document.getElementById('metricGeneration').textContent = stats.generation;
            document.getElementById('metricGames').textContent = stats.completeGames;
            document.getElementById('metricSpeed').textContent = stats.gamesPerSec.toFixed(1);
            document.getElementById('metricPositions').textContent = stats.positionsExplored;
            document.getElementById('metricStability').textContent = (stats.learningMetrics.stability * 100).toFixed(1) + '%';
            document.getElementById('metricGrowth').textContent = (stats.learningMetrics.coverageGrowth * 100).toFixed(1) + '%';
        }

        function exportPolicy() {
            if (!runner || !runner.policy) {
                alert('No policy to export. Run training first.');
                return;
            }

            const filename = `hexuki_policy_phase2_gen${runner.generationHistory.length}_${Date.now()}.json`;
            runner.policy.save(filename);
            console.log(`✅ Policy exported: ${filename}`);
        }

        function exportLogs() {
            if (!runner || !runner.logger) {
                alert('No logs to export. Run training first.');
                return;
            }

            runner.logger.exportLogs();
        }

        console.log('Ready! Configure training settings and click "Start Training".\n');
    </script>
</body>
</html>
